<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <title>Step 5: Create
         the Lambda Function That Processes the Incoming Records - Amazon Pinpoint
      </title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <link rel="home" href="#top" />
      <link rel="up" href="tutorials-importing-data.html" title="Tutorial: Importing Data Into Amazon Pinpoint From External&#xA;            Sources" />
      <link rel="prev" href="tutorials-importing-data-lambda-function-input-split.html" title="Step 4: Create the&#xA;            Lambda Function That Splits Input Data" />
      <link rel="next" href="tutorials-importing-data-lambda-function-import-job.html" title="Step 6: Create the&#xA;            Lambda Function Imports Records Into Amazon Pinpoint" />
      <meta name="description" content="The next Lambda function that you create processes the records in the incoming files that were created by the function that you created in Step 4 . Specifically, it does the following things:" />
      <meta name="keywords" content="Pinpoint,Amazon Pinpoint,Customer engagement,Segmentation,Campaigns,Metrics" />
      <meta name="deployment_region" content="IAD" />
      <meta name="product" content="Amazon Pinpoint" />
      <meta name="guide" content="Developer Guide" />
      <meta name="guide-locale" content="en_us" />
      <meta name="tocs" content="toc-contents.json" />
      <link rel="icon" type="image/ico" href="images/favicon.ico" />
      <link rel="shortcut icon" type="image/ico" href="images/favicon.ico" />
      <link rel="canonical" href="https://docs.aws.amazon.com/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html" />
      <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css" />
      <link rel="stylesheet" type="text/css" href="font/css/font-awesome.min.css" />
      <link rel="stylesheet" type="text/css" href="css/google-font.css" />
      <link id="code-style" rel="stylesheet" type="text/css" href="css/code/light.css" />
      <link rel="stylesheet" type="text/css" href="css/jquery-ui.theme.css" />
      <link rel="stylesheet" type="text/css" href="css/colorbox.css" />
      <link rel="stylesheet" type="text/css" href="css/awsdocs.css?v=20181221" /><script type="text/javascript" src="js/highlight.pack.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/jquery-ui.min.js"></script><script type="text/javascript" src="js/jquery.colorbox.js"></script><script type="text/javascript" src="js/awsdocs.min.js?v=20181221"></script></head>
   <body id="top">
      <div xmlns:db="http://docbook.org/ns/docbook" id="aws-nav" class="aws-nav-header">
         <div class="aws-nav-header-left">
            <div class="aws-nav-logo">
               <!--aws_logo_105x39.png--><a href="http://aws.amazon.com"><img src="images/aws_logo_105x39.png" alt="Amazon Web Services" /></a></div>
         </div>
         <div id="aws-nav-header-right" class="aws-nav-header-right">
            <div class="aws-nav-cta-button-outer"><a id="aws-nav-cta-button" class="aws-nav-button" href="https://console.aws.amazon.com/console/home">Sign In to the Console</a></div>
            <div class="aws-nav-popover-trigger" data-dropdown="aws-nav-dropdown-lang"><select id="languageSelection" onchange="SelectLanguage()">
                  <option value="/de_de/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">Deutsch</option>
                  <option value="/en_us/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html" selected="selected">English</option>
                  <option value="/es_es/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">Español</option>
                  <option value="/fr_fr/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">Français</option>
                  <option value="/it_it/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">Italiano</option>
                  <option value="/ja_jp/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">日本語</option>
                  <option value="/ko_kr/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">한국어</option>
                  <option value="/pt_br/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">Português</option>
                  <option value="/zh_cn/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">中文 (简体)</option>
                  <option value="/zh_tw/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">中文 (繁體)</option></select></div><a class="btn btn-kindle-link" id="kindle-link-top" target="_blank" href="http://www.amazon.com/dp/B07JKHTQVP" title="Open Kindle"></a><a class="btn btn-pdf-link" id="pdf-link-top" href="pinpoint-dg.pdf#tutorials-importing-data-lambda-function-process-incoming" target="_blank" title="Open PDF"></a><a class="btn btn-github-link" id="github-link-top" href="https://github.com/awsdocs/amazon-pinpoint-developer-guide/tree/master/doc-source/tutorials-importing-data-lambda-function-process-incoming.md" target="_blank" title="Edit on GitHub"></a><div id="aws-nav-quicklinks-separator" class="aws-nav-quicklinks-separator">
               <div class="aws-nav-left"></div>
               <div class="aws-nav-right"></div>
            </div>
         </div>
      </div>
      <div id="content-container">
         <div id="left-column">
            <div id="left-col-header">
               <div xmlns:db="http://docbook.org/ns/docbook" id="left-col-top-content">
                  <div id="service-name">Amazon Pinpoint </div>
                  <div id="search"><i id="search-icon" class="fa fa-search fa-2x"></i></div>
                  <div id="guide-info">Developer Guide
                     <div id="content-button"><i id="toggle-contents" class="fa fa-bars"></i></div>
                  </div>
               </div>
               <form id="finegrainedSearch" method="get" onsubmit="return searchFormSubmit(this);" action="/search/doc-search.html">
                  <div id="search-form"><select id="search-select" name="searchPath">
                        <option value="all">Entire Site</option>
                        <option value="AWSMarketplace">AMIs from AWS Marketplace</option>
                        <option value="amis">AMIs from All Sources</option>
                        <option value="articles">Articles &amp; Tutorials</option>
                        <option value="products_and_info">AWS Product Information</option>
                        <option value="case_studies">Case Studies</option>
                        <option value="customerapps">Customer Apps</option>
                        <option value="documentation">Documentation</option>
                        <option value="documentation-product">Documentation - This Product</option>
                        <option value="documentation-guide" selected="selected">Documentation - This Guide</option>
                        <option value="datasets">Public Data Sets</option>
                        <option value="releasenotes">Release Notes</option>
                        <option value="solution_providers">Partners</option>
                        <option value="code">Sample Code &amp; Libraries</option></select><br /><input id="search-query" name="searchQuery" type="text" placeholder="Search" /><input id="search-button" src="images/search-button.png" alt="Go" type="image" /></div><input type="hidden" name="this_doc_product" id="this_doc_product" value="Amazon Pinpoint" /><input type="hidden" name="this_doc_guide" id="this_doc_guide" value="Developer Guide" /><input type="hidden" name="doc_locale" value="en_us" /></form>
            </div>
            <div id="toc"></div>
         </div>
         <div id="main-column">
            <div id="main">
               <div id="main-content">
                  <div id="main-col-body">
                     <table summary="Breadcrumbs">
                        <tr>
                           <td>
                              <div class="breadcrumb"><a href="/index.html">AWS Documentation</a> » <a href="/pinpoint/index.html">Amazon Pinpoint</a> » <a href="index.html">Developer Guide</a> » <a href="tutorials.html">Tutorials</a> » <a href="tutorials-importing-data.html">Tutorial: Importing Data Into Amazon Pinpoint From External
                                    Sources</a> » <span class="breadcrumb">Step 5: Create
                                    the Lambda Function That Processes the Incoming Records</span></div>
                           </td>
                        </tr>
                     </table>
                     <div id="language-notice">
                        <div class="language-notice-text"></div>
                     </div>
                     <div></div>
                     <h1 class="topictitle" id="tutorials-importing-data-lambda-function-process-incoming">Step 5: Create
                        the Lambda Function That Processes the Incoming Records
                     </h1>
                     <p>The next Lambda function that you create processes the records in the incoming files
                        that
                        were created by the function that you created in <a href="tutorials-importing-data-lambda-function-input-split.html">Step 4</a>.
                        Specifically, it does the following things:
                     </p>
                     <div class="itemizedlist">
                        
                        
                        
                        
                        
                        
                        <ul class="itemizedlist" type="disc">
                           <li class="listitem">
                              
                              <p>Changes the headers in the incoming file to values that Amazon Pinpoint expects to
                                 see.
                              </p>
                              
                           </li>
                           <li class="listitem">
                              
                              <p>Converts some of the contact information in the input spreadsheet into a format
                                 that Amazon Pinpoint expects. For example, the value "United States" in the <code class="code">Mailing
                                    Country</code> column is converted to "US" in the
                                 <code class="code">Location.Country</code> column of the output file, because Amazon Pinpoint
                                 expects countries to represented in ISO-3166-1 format.
                              </p>
                              
                           </li>
                           <li class="listitem">
                              
                              <p>Sends every phone number that it finds to the phone number validation service.
                                 This step ensures that all phone numbers are converted to E.164 format. It also
                                 determines the phone number type. Mobile phone numbers are created as SMS endpoints,
                                 while all other phone numbers are created as Voice endpoints.
                              </p>
                              
                           </li>
                           <li class="listitem">
                              
                              <p>Writes separate rows for each endpoint that it finds. For example, if one row in
                                 the input file contains a phone number and an email address, then the output file
                                 contains a separate row for each of those endpoints. However, the two records are
                                 united by a common User ID.
                              </p>
                              
                           </li>
                           <li class="listitem">
                              
                              <p>Checks to see if endpoint IDs in the incoming file already exist in the Amazon Pinpoint
                                 project. If they do, the Lambda function updates the existing records rather than
                                 creating new ones.
                              </p>
                              
                           </li>
                        </ul>
                     </div>
                     <p>When the function finishes processing the input files, it sends them to a folder in
                        the
                        <code>processed</code> directory.
                     </p>
                     
                     <h2 id="tutorials-importing-data-lambda-function-process-incoming-create">Step 5.1: Create the Function</h2>
                     
                     <p>The process of creating this function is similar to the process that you completed
                        in
                        <a href="tutorials-importing-data-lambda-function-input-split.html">Step 4</a>
                        of this tutorial. First, you upload the .zip file that contains the necessary libraries.
                        Next, you create two Python files. 
                     </p>
                     
                     <p class="title"><b>To create the Lambda function</b></p>
                     <ol>
                        <li>
                           <p>Open the AWS Lambda console at
                              <a href="https://console.aws.amazon.com/lambda/" target="_blank">https://console.aws.amazon.com/lambda/</a>.
                           </p>
                        </li>
                        <li>
                           
                           <p>Choose <b>Create function</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Choose <b>Author from scratch</b>. Under <b>Basic
                                 information</b>, do the following:
                           </p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p>For <b>Function name</b>, enter
                                       <b>CustomerImport_ProcessInput</b>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>For <b>Runtime</b>, choose <b>Python
                                          3.7</b>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>For <b>Execution role</b>, choose <b>Use an
                                          existing role</b>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>For <b>Existing role</b>, choose
                                       <b>ImporterPinpointRole</b>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>Choose <b>Create function</b>. 
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Function code</b>, for <b>Code entry
                                 type</b>, choose <b>Upload a .zip file</b>. Under
                              <b>Function package</b>, choose <b>Upload</b>.
                              Choose the <code>pinpoint-importer.zip</code> file that you created in
                              <a href="tutorials-importing-data-create-python-package.html">Step
                                 3</a>. After you select the file, choose <b>Save</b>. 
                           </p>
                           
                           <div class="aws-note">
                              <p class="aws-note">Note</p>
                              <p>After you choose <b>Save</b>, you receive an error message
                                 stating that Lambda couldn’t open the file
                                 <code>lambda_function.py</code>. Dismiss this error; you create
                                 this file in the next step.
                              </p>
                           </div>
                           
                        </li>
                        <li>
                           
                           <p>In the function editor, on the <b>File</b> menu, choose
                              <b>New File</b>. The editor creates a new file named
                              <code>Untitled1</code>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Paste the following code in the editor:</p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="python ">import io
import os
import csv
import time
import uuid
import boto3
import s3fs
import input_internationalization as i18n
from datetime import datetime
from botocore.exceptions import ClientError

# You might need to change some things to fit your specific needs.

# If incoming data doesn't specify a country, you have to pass a default value.
# Specify a default country code in ISO 3166-1 alpha-2 format.
defaultCountry = "US"

# The column header names that are applied to the output file. You might need to 
# change the order of the items in this list to suit the data that's in the file
# that you want to import. Column numbers are included as comments here to make it
# easier to align the columns.
# If you add columns here, you also need to add them in the process_incoming_file
# function below. Specifically, you need to add them to the lists that the
# Filewriter object uses to write the processed files. See the sections that 
# begin at lines 137 and 175 below.
header =    [                                               #Col num in input
                'ChannelType',                              #not in input
                'Address',                                  #9 (phone), 10 (email)
                'Id',                                       #9 (phone), 10 (email)
                'User.UserAttributes.City',                 #5
                'User.UserAttributes.Region',               #6
                'User.UserAttributes.PostalCode',           #7
                'Location.Country',                         #8
                'User.UserAttributes.Salutation',           #0
                'User.UserAttributes.FirstName',            #1
                'User.UserAttributes.LastName',             #2
                'User.UserAttributes.Title',                #3
                'User.UserAttributes.StreetAddress',        #4
                'User.UserAttributes.ContactRecordType',    #11
                'User.UserAttributes.AccountName',          #12
                'User.UserAttributes.AccountOwner',         #13
                'User.UserAttributes.LeadSource',           #14
                'User.UserId'                               #not in input
            ]

# You probably don't need to change any variables below this point.
AWS_REGION = os.environ['region']
projectId = os.environ['projectId']
processed_folder = "processed"
startTime = datetime.now()
s3 = s3fs.S3FileSystem(anon=False)

def lambda_handler(event, context):
    print("Received event: " + str(event))
    
    for record in event['Records']:
        # Create some variables that make it easier to work with the data in the
        # event record.
        bucket = record['s3']['bucket']['name']
        key = record['s3']['object']['key']
        input_file = os.path.join(bucket,key)
        output_file_name = os.path.splitext(os.path.basename(input_file))[0] + "_processed.csv"
        processed_subfolder = os.path.basename(input_file).split("__part",1)[0]
        output_fullpath = os.path.join(bucket,processed_folder,processed_subfolder,output_file_name)
        # Start the function that processes the incoming data.
        process_incoming_file(input_file, output_fullpath)

# Check the current project to see if an endpoint ID already exists.
def check_endpoint_exists(endpointId):
    client = boto3.client('pinpoint',region_name=AWS_REGION)

    try:
        response = client.get_endpoint(
            ApplicationId=projectId,
            EndpointId=endpointId
        )
    except ClientError as e:
        endpointInfo = [ False, "" ]
    else:
        userId = response['EndpointResponse']['User']['UserId']
        endpointInfo = [ True, userId ]

    return endpointInfo

# Change the column names, validate and reformat some of the input, and then 
# write to output files.
def process_incoming_file(input_file, output_file):
    # Counters for tracking the number of records and endpoints processed.
    line_count = 0
    create_count = 0
    update_count = 0
    
    folder = os.path.split(output_file)[0]
    
    with s3.open(output_file, 'w', newline='', encoding='utf-8-sig') as outFile:
        fileWriter = csv.writer(outFile)
        with s3.open(input_file, 'r', newline='', encoding='utf-8-sig') as inFile:
            fileReader = csv.reader(inFile)
    
            for row in fileReader:
                # Sleep to prevent throttling errors.
                time.sleep(.025)
                # Write the header row.
                if (line_count == 0):
                    fileWriter.writerow(header)
                    line_count += 1
                # Write the rest of the data.
                else:
                    # Generate a new UUID.
                    userId = str(uuid.uuid4())
    
                    # Varibles that make things easier to read.
                    inputEmail = row[10]
                    inputPhone = row[9]
                    inputCountry = row[8]
    
                    # If a country is included in the incoming record, create a
                    # variable that contains the ISO 3166-1 alpha-2 country code.
                    if inputCountry:
                        country = i18n.get_country_code(inputCountry, defaultCountry)
                    # If no country code is provided, create a variable that contains a
                    # default country code. Change this if you want to use a different
                    # default value.
                    elif not inputCountry:
                        country = defaultCountry
    
                    if inputEmail:
    
                        emailEndpointInfo = check_endpoint_exists(inputEmail)
    
                        if emailEndpointInfo[0]:
                            userId = emailEndpointInfo[1]
                            update_count += 1
                        else:
                            create_count += 1
    
                        fileWriter.writerow([
                                                "EMAIL",
                                                row[10],
                                                row[10],
                                                row[5],     #City
                                                row[6],     #Region
                                                row[7],     #Postal code
                                                country,    #Country
                                                row[0],     #Salutation
                                                row[1],     #First name
                                                row[2],     #Last name
                                                row[3],     #Title
                                                row[4],     #Street address
                                                row[11],    #Contact record type
                                                row[12],    #Account name
                                                row[13],    #Account owner
                                                row[14],    #Lead source
                                                userId
                                            ])
    
                    if inputPhone:
                        phoneInfo = i18n.check_phone_number(country, inputPhone, AWS_REGION)
                        cleansedPhone = phoneInfo[0]
                        phoneType = phoneInfo[1]
    
                        if (phoneType == "MOBILE") or (phoneType == "PREPAID"):
                            phoneType = "SMS"
                        else:
                            phoneType = "VOICE"
    
                        phoneEndpointInfo = check_endpoint_exists(cleansedPhone)
    
                        if phoneEndpointInfo[0]:
                            userId = phoneEndpointInfo[1]
                            update_count += 1
                        else:
                            create_count += 1
    
                        fileWriter.writerow([
                                                phoneType,
                                                cleansedPhone,
                                                cleansedPhone,
                                                row[5],     #City
                                                row[6],     #Region
                                                row[7],     #Postal code
                                                country,    #Country
                                                row[0],     #Salutation
                                                row[1],     #First name
                                                row[2],     #Last name
                                                row[3],     #Title
                                                row[4],     #Street address
                                                row[11],    #Contact record type
                                                row[12],    #Account name
                                                row[13],    #Account owner
                                                row[14],    #Lead source
                                                userId
                                            ])
                    line_count += 1
    
    # Calculate the amount of time the script ran.
    duration = datetime.now() - startTime
    
    # Print the number of records processed. Subtract 1 to account for the header.
    print("Processed " + str(line_count - 1) + " records in " + str(duration)
            + ". ", end="")
    
    # Print the numbers of endpoints created and updated.
    print("Found " + str(create_count) + " new endpoints and "
            + str(update_count) + " existing endpoints.")

    s3.rm(input_file)</code></pre>
                           </li>
                        <li>
                           
                           <p>In the function editor, on the <b>File</b> menu, choose
                              <b>Save As</b>. Save the file as
                              <code>lambda_function.py</code> in the root directory for the
                              function.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>In the function editor, on the <b>File</b> menu, choose
                              <b>New File</b>. The editor creates a new file named
                              <code>Untitled1</code>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Paste the following code in the editor:</p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="python ">import re
import boto3
from botocore.exceptions import ClientError

def get_country_code(country, default):
    # The Location.Country attribute expects an ISO 3166-1 Alpha 2 formatted
    # country name. This function attempts to identify several possible
    # variations of each country name and convert them to the required format.
    # This function exists so that the program doesn't need to rely on non-
    # standard libraries. Update this section to suit the data in your existing
    # content management system.
    # This section includes common aliases for the 10 most populous countries
    # in the world, and some additional countries where Amazon Pinpoint is often used to
    # send SMS messages. If necessary, expand this section to include
    # additional countries, or additional aliases for the countries that are
    # already listed.
    country = country.strip().lower()

    bangladeshAliases = [ "bd", "bgd", "bangladesh", "বাংলাদেশ" ]
    brazilAliases     = [ "br", "bra", "brazil", "brasil",
                          "república federativa do brasil" ]
    canadaAliases     = [ "ca", "can", "canada" ]
    chinaAliases      = [ "cn", "chn", "prc", "proc", "china",
                          "people's republic of china", "中华人民共和国", "中国" ]
    indiaAliases      = [ "in", "ind", "india", "republic of india" ]
    indonesiaAliases  = [ "id", "idn", "indonesia", "republic of indonesia",
                          "republik indonesia" ]
    irelandAliases    = [ "ie", "irl", "ireland", "éire" ]
    japanAliases      = [ "jp", "jpn", "japan", "日本" ]
    mexicoAliases     = [ "mx", "mex", "mexico", "méxico",
                          "estados unidos mexicanos" ]
    nigeriaAliases    = [ "ng", "nga", "nigeria" ]
    pakistanAliases   = [ "pk", "pak", "pakistan", "پاکستان" ]
    russiaAliases     = [ "ru", "rus", "russian federation", "росси́я",
                          "росси́йская федера́ция" ]
    ukAliases         = [ "uk", "gb", "gbr", "united kingdom", "britain",
                          "england", "wales", "scotland", "northern ireland" ]
    usAliases         = [ "us", "usa", "united states",
                          "united states of america" ]

    if country in bangladeshAliases:
        countryISO3166 = "BD"
    elif country in brazilAliases:
        countryISO3166 = "BR"
    elif country in canadaAliases:
        countryISO3166 = "CA"
    elif country in chinaAliases:
        countryISO3166 = "CN"
    elif country in indiaAliases:
        countryISO3166 = "IN"
    elif country in indonesiaAliases:
        countryISO3166 = "ID"
    elif country in irelandAliases:
        countryISO3166 = "IE"
    elif country in japanAliases:
        countryISO3166 = "JP"
    elif country in mexicoAliases:
        countryISO3166 = "MX"
    elif country in nigeriaAliases:
        countryISO3166 = "NG"
    elif country in pakistanAliases:
        countryISO3166 = "PK"
    elif country in russiaAliases:
        countryISO3166 = "RU"
    elif country in ukAliases:
        countryISO3166 = "GB"
    elif country in usAliases:
        countryISO3166 = "US"
    else:
        countryISO3166 = default

    return countryISO3166

def check_phone_number(country, phone, region):

    client = boto3.client('pinpoint',region_name=region)

    # Phone number validation can generate an E.164-compliant phone number as
    # long as you provide it with the correct country code. This function looks
    # for the appropriate country code at the beginning of the phone number. If
    # the country code isn't present, it adds it to the beginning of the phone
    # number that was provided to the function, and then sends it to the phone
    # number validation service. The phone number validation service performs
    # additional cleansing of the phone number, removing things like
    # unnecessary leading digits. It also provides metadata, such as the phone
    # number type (mobile, landline, etc.).
    # Add more countries and regions to this function if necessary.
    phone =  re.sub("[^0-9]", "", phone)

    if (country == 'BD') and not phone.startswith('880'):
        phone = "+880" + phone
    elif (country == 'BR') and not phone.startswith('55'):
        phone = "+55" + phone
    elif (country == 'CA' or country == 'US') and not phone.startswith('1'):
        # US and Canada (country code 1) area codes and phone numbers can't use
        # 1 as their first digit, so it's fine to search for a 1 at the
        # beginning of the phone number to determine whether or not the number
        # contains a country code.
        phone = "+1" + phone
    elif (country == 'CN') and not phone.startswith('86'):
        phone = "+86" + phone
    elif (country == 'IN') and not phone.startswith('91'):
        phone = "+91" + phone
    elif (country == 'ID') and not phone.startswith('62'):
        phone = "+62" + phone
    elif (country == 'IE') and not phone.startswith('353'):
        phone = "+353" + phone
    elif (country == 'JP') and not phone.startswith('81'):
        phone = "+81" + phone
    elif (country == 'MX') and not phone.startswith('52'):
        phone = "+52" + phone
    elif (country == 'NG') and not phone.startswith('234'):
        phone = "+234" + phone
    elif (country == 'PK') and not phone.startswith('92'):
        phone = "+92" + phone
    elif (country == 'RU') and not phone.startswith('7'):
        # No area codes in Russia begin with 7. However, Kazakhstan also uses
        # country code 7, and Kazakh area codes can begin with 7. If your
        # contact database contains Kazakh phone numbers, you might have to
        # use some additional logic to identify them.
        phone = "+7" + phone
    elif (country == 'GB') and not phone.startswith('44'):
        phone = "+44" + phone

    try:
        response = client.phone_number_validate(
            NumberValidateRequest={
                'IsoCountryCode': country,
                'PhoneNumber': phone
            }
        )
    except ClientError as e:
        print(e.response)
    else:
        returnValues = [
            response['NumberValidateResponse']['CleansedPhoneNumberE164'],  response['NumberValidateResponse']['PhoneType']
        ]
        return returnValues
</code></pre>
                           </li>
                        <li>
                           
                           <p>In the function editor, on the <b>File</b> menu, choose
                              <b>Save As</b>. Save the file as
                              <code>input_internationalization.py</code> in the root directory for
                              the function.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Environment variables</b>, do the following:
                           </p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p>In the first row, create a variable with a key of
                                       <strong class="userinput"><code>projectId</code></strong>. Next, set the value to the unique
                                       ID of the project that you specified in the IAM policy in <a href="tutorials-importing-data-create-iam-roles.html#tutorials-importing-data-create-iam-roles-pinpoint">Step
                                          2.2</a>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>In the second row, create a variable with a key of
                                       <strong class="userinput"><code>region</code></strong>. Next, set the value to the Region
                                       that that you specified in the IAM policy in <a href="tutorials-importing-data-create-iam-roles.html#tutorials-importing-data-create-iam-roles-pinpoint">Step
                                          2.2</a>.
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                           <p>When you finish, the <b>Environment Variables</b> section should
                              resemble the example shown in the following image.
                           </p>
                           
                           <div class="mediaobject">
                              
                              <img src="images/Email_Prefs_Tutorial_LAM_Step4.1_7.png" />
                              
                              
                           </div>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Basic settings</b>, set the
                              <b>Timeout</b> value to 6 minutes.
                           </p>
                           
                           <div class="aws-note">
                              <p class="aws-note">Note</p>
                              <p>Each call to the phone number validation service typically takes about .5
                                 seconds to complete, but can occasionally take longer. If you don't increase
                                 the <b>Timeout</b> value, the function might time out before
                                 it finishes processing the incoming records. This setting gives the Lambda
                                 function plenty of time to finish running.
                              </p>
                           </div>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Concurrency</b>, choose <b>Reserve
                                 concurrency</b>, and then set the value to <code class="code">20</code>.
                           </p>
                           
                           <div class="aws-note">
                              <p class="aws-note">Note</p>
                              <p>Higher concurrency limits might cause the files to be processed faster.
                                 However, if the concurrency value is too high, you start to generate a
                                 number of PUT events that exceeds the limits of Amazon S3. As a result, the
                                 import process doesn't capture all of the data in your input spreadsheet,
                                 because many of the requests that are generated by this function end in
                                 failure.
                              </p>
                           </div>
                           
                        </li>
                        <li>
                           
                           <p>At the top of the page, choose <b>Save</b>.
                           </p>
                           
                        </li>
                     </ol>
                     
                     
                     <h2 id="tutorials-importing-data-lambda-function-process-incoming-test">Step 5.2: Test the Function</h2>
                     
                     <p>After you create the function, you should test it to ensure that it's set up
                        correctly.
                     </p>
                     
                     <p class="title"><b>To test the Lambda function</b></p>
                     <ol>
                        <li>
                           
                           <p>Choose <b>Test</b>. On the <b>Configure test
                                 event</b> window, for <b>Event name</b>, enter
                              <strong class="userinput"><code>TestEvent</code></strong>. Then, in the editor, paste the following
                              code:
                           </p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="json ">{
  "Records": [
    {
      "s3": {
        "bucket": {
          "name": "<em class="replaceable"><code>bucket-name</code></em>",
          "arn": "arn:aws:s3:::<em class="replaceable"><code>bucket-name</code></em>"
        },
        "object": {
          "key": "to_process/testfile__part1__of1.csv"
        }
      }
    }
  ]
}</code></pre>
                           <p>In the preceding example, replace <em class="replaceable"><code>bucket-name</code></em> with
                              the name of the Amazon S3 bucket that you created in <a href="tutorials-importing-data-create-iam-roles.html">Step 1</a>. When you
                              finish, choose <b>Create</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Choose <b>Test</b> again. The function executes with the test
                              event that you provided.
                           </p>
                           
                           <p>If the function runs as expected, proceed to the next step.</p>
                           
                           <p>If the function fails to complete, do the following: </p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p>Make sure that you specified the correct bucket name in the IAM
                                       policy that you created in <a href="tutorials-importing-data-create-s3-bucket.html">Step 1: Create an Amazon S3
                                          Bucket</a>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>Make sure that the Lambda test event that you created in step 1 of this
                                       section refers to the correct bucket and file name.
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                        </li>
                        <li> 
                           <p>Open the Amazon S3 console at
                              <a href="https://console.aws.amazon.com/s3/" target="_blank">https://console.aws.amazon.com/s3/</a>.
                           </p> 
                           <p>Choose the bucket that you created in <a href="tutorials-importing-data-create-s3-bucket.html">Step 1: Create an Amazon S3
                                 Bucket</a>.
                           </p>
                           
                           <p>Open the folders in the bucket and take note of the contents of each one. If
                              all of the following statements are true, then the Lambda function worked as
                              expected:
                           </p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p>The <code>to_process</code> folder doesn't contain any
                                       files.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>The processed folder contains a subfolder named
                                       <code>testfile</code>. Within the
                                       <code>testfile</code> folder, there is a file named
                                       <code>testfile__part1__of1_processed.csv</code>. 
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                           <p>Don't delete any of the newly generated files. The Lambda function that you
                              create in the next step uses the files in the <code>to_process</code>
                              folder.
                           </p>
                           
                        </li>
                     </ol>
                     
                     <p><b>Next</b>: <a href="tutorials-importing-data-lambda-function-import-job.html">Create the Lambda Function
                           Imports Records Into Amazon Pinpoint</a></p>
                  </div>
                  <noscript>
                     <div>
                        <div>
                           <div>
                              <div id="js_error_message">
                                 <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p>
                                 <p>To use the AWS Documentation, Javascript must be enabled. Please refer to your browser's
                                    Help pages for instructions.
                                 </p>
                              </div>
                           </div>
                        </div>
                     </div>
                  </noscript>
                  <div id="main-col-footer">
                     <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                     <div id="next"><a class="awstoc" accesskey="p" href="tutorials-importing-data-lambda-function-input-split.html">« Previous </a><a class="awstoc" accesskey="n" href="tutorials-importing-data-lambda-function-import-job.html">Next »</a></div>
                     <div id="copyright-main-footer">© 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.</div>
                  </div>
               </div>
            </div>
            <div id="right-expanded">
               <div id="right-content-wrapper">
                  <div id="pagetoc">
                     <p>On this page:</p>
                     <ul class="pagetoc">
                        <li class="pagetoc" name="Step 5.1: Create the Function"><a class="pagetoc" href="#tutorials-importing-data-lambda-function-process-incoming-create">Step 5.1: Create the Function</a></li>
                        <li class="pagetoc" name="Step 5.2: Test the Function"><a class="pagetoc" href="#tutorials-importing-data-lambda-function-process-incoming-test">Step 5.2: Test the Function</a></li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div id="cookie-notice">
         <div class="cookie-notice-text">We use cookies to provide and improve our services. By using our site, you consent
            to cookies. <a href="http://aws.amazon.com/legal/cookies">Learn more</a></div>
      </div>
      <div id="footer">
         <div id="footer_short_fb" class="hide" title="Feedback"><a target="_blank" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Pinpoint&amp;topic_url=http://docs.aws.amazon.com/en_us/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html&amp;hidden_guide_name=Developer Guide&amp;hidden_api_version=&amp;hidden_file_name=tutorials-importing-data-lambda-function-process-incoming"><i class="awsdocs-footer-text fa fa-envelope-o"></i></a></div>
         <div id="footer_toggle" class="mediaobject">
            <div id="footer_toggle_img" class="awsdocs-footer-text fa fa-caret-down"></div>
            <div id="footer_toggle_img_collapse" class="hide awsdocs-footer-text fa fa-caret-right"></div>
         </div>
         <div id="footer-left"><a class="awsdocs-footer-text" target="_top" href="http://aws.amazon.com/terms">Terms of Use</a><span class="awsdocs-footer-text"> | </span><a class="awsdocs-footer-text" target="_top" href="http://aws.amazon.com/privacy">Privacy</a><span class="awsdocs-footer-text"> | </span><span class="awsdocs-footer-text">© 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.</span></div>
         <div id="footer-right">
            <div id="feedback">
               <div id="forums"><a id="forum_link" target="_blank" href="http://forums.aws.amazon.com/forum.jspa?forumID=225" class="awsdocs-footer-text">Have a question? Try the Forums.</a></div>
               <div id="feedback-message" class="awsdocs-footer-text">Did this page help you?</div>
               <div id="feedback-yesno-buttons"><a class="awstoc btn btn-default" target="_blank" href="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">Yes</a><a class="awstoc btn btn-default" target="_blank" href="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html">No</a></div>
               <div id="feedback-feedback-button"><a class="awstoc btn btn-default" target="_blank" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Pinpoint&amp;topic_url=http://docs.aws.amazon.com/en_us/pinpoint/latest/developerguide/tutorials-importing-data-lambda-function-process-incoming.html&amp;hidden_guide_name=Developer Guide&amp;hidden_api_version=&amp;hidden_file_name=tutorials-importing-data-lambda-function-process-incoming">Feedback</a></div>
            </div>
         </div>
      </div>
      <!-- SiteCatalyst code version: H.25.2.
            Copyright 1996-2012 Adobe, Inc. All Rights Reserved
            More info available at http://www.omniture.com --><script language="JavaScript" type="text/javascript" src="https://a0.awsstatic.com/s_code/js/1.0/awshome_s_code.js"></script><script language="JavaScript" type="text/javascript">
         <!--

            // Documentation Service Name
            s.prop66='Amazon Pinpoint';
            s.eVar66='D=c66';
  
            // Documentation Guide Name                                                                 
            s.prop65='Developer Guide';
            s.eVar65='D=c65';

            var s_code=s.t();if(s_code)document.write(s_code)//--></script><script language="JavaScript" type="text/javascript">
         <!--
                if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
                //--></script><noscript><img src="https://amazonwebservices.d2.sc.omtrdc.net/b/ss/awsamazondev/1/H.25.2--NS/0" height="1" width="1" border="0" alt="" /></noscript>
      <!--/DO NOT REMOVE/-->
      <!-- End SiteCatalyst code version: H.25.2. -->
   </body>
</html>