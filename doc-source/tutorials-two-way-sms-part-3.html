<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <title>Step 3: Create Lambda Functions - Amazon Pinpoint</title>
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <link rel="home" href="#top" />
      <link rel="up" href="tutorials-two-way-sms.html" title="Tutorial: Setting Up an SMS Registration&#xA;            System" />
      <link rel="prev" href="tutorials-two-way-sms-part-2.html" title="Step 2: Create IAM Policies and&#xA;            Roles" />
      <link rel="next" href="tutorials-two-way-sms-part-4.html" title="Step 4: Set Up Amazon API Gateway" />
      <meta name="description" content="This solution uses two Lambda functions. This section shows you how to create and configure these functions. Later, you set up API Gateway and Amazon Pinpoint to execute these functions when certain events occur. Both of these functions create and update endpoints in the Amazon Pinpoint project that you specify. The first function also uses the phone number validation feature." />
      <meta name="keywords" content="Pinpoint,Amazon Pinpoint,Customer engagement,Segmentation,Campaigns,Metrics" />
      <meta name="deployment_region" content="IAD" />
      <meta name="product" content="Amazon Pinpoint" />
      <meta name="guide" content="Developer Guide" />
      <meta name="guide-locale" content="en_us" />
      <meta name="tocs" content="toc-contents.json" />
      <link rel="icon" type="image/ico" href="images/favicon.ico" />
      <link rel="shortcut icon" type="image/ico" href="images/favicon.ico" />
      <link rel="canonical" href="https://docs.aws.amazon.com/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html" />
      <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css" />
      <link rel="stylesheet" type="text/css" href="font/css/font-awesome.min.css" />
      <link rel="stylesheet" type="text/css" href="css/google-font.css" />
      <link id="code-style" rel="stylesheet" type="text/css" href="css/code/light.css" />
      <link rel="stylesheet" type="text/css" href="css/jquery-ui.theme.css" />
      <link rel="stylesheet" type="text/css" href="css/colorbox.css" />
      <link rel="stylesheet" type="text/css" href="css/awsdocs.css?v=20181221" /><script type="text/javascript" src="js/highlight.pack.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/jquery-ui.min.js"></script><script type="text/javascript" src="js/jquery.colorbox.js"></script><script type="text/javascript" src="js/awsdocs.min.js?v=20181221"></script></head>
   <body id="top">
      <div xmlns:db="http://docbook.org/ns/docbook" id="aws-nav" class="aws-nav-header">
         <div class="aws-nav-header-left">
            <div class="aws-nav-logo">
               <!--aws_logo_105x39.png--><a href="http://aws.amazon.com"><img src="images/aws_logo_105x39.png" alt="Amazon Web Services" /></a></div>
         </div>
         <div id="aws-nav-header-right" class="aws-nav-header-right">
            <div class="aws-nav-cta-button-outer"><a id="aws-nav-cta-button" class="aws-nav-button" href="https://console.aws.amazon.com/console/home">Sign In to the Console</a></div>
            <div class="aws-nav-popover-trigger" data-dropdown="aws-nav-dropdown-lang"><select id="languageSelection" onchange="SelectLanguage()">
                  <option value="/de_de/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">Deutsch</option>
                  <option value="/en_us/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html" selected="selected">English</option>
                  <option value="/es_es/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">Español</option>
                  <option value="/fr_fr/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">Français</option>
                  <option value="/it_it/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">Italiano</option>
                  <option value="/ja_jp/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">日本語</option>
                  <option value="/ko_kr/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">한국어</option>
                  <option value="/pt_br/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">Português</option>
                  <option value="/zh_cn/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">中文 (简体)</option>
                  <option value="/zh_tw/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">中文 (繁體)</option></select></div><a class="btn btn-kindle-link" id="kindle-link-top" target="_blank" href="http://www.amazon.com/dp/B07JKHTQVP" title="Open Kindle"></a><a class="btn btn-pdf-link" id="pdf-link-top" href="pinpoint-dg.pdf#tutorials-two-way-sms-part-3" target="_blank" title="Open PDF"></a><a class="btn btn-github-link" id="github-link-top" href="https://github.com/awsdocs/amazon-pinpoint-developer-guide/tree/master/doc-source/tutorials-two-way-sms-part-3.md" target="_blank" title="Edit on GitHub"></a><div id="aws-nav-quicklinks-separator" class="aws-nav-quicklinks-separator">
               <div class="aws-nav-left"></div>
               <div class="aws-nav-right"></div>
            </div>
         </div>
      </div>
      <div id="content-container">
         <div id="left-column">
            <div id="left-col-header">
               <div xmlns:db="http://docbook.org/ns/docbook" id="left-col-top-content">
                  <div id="service-name">Amazon Pinpoint </div>
                  <div id="search"><i id="search-icon" class="fa fa-search fa-2x"></i></div>
                  <div id="guide-info">Developer Guide
                     <div id="content-button"><i id="toggle-contents" class="fa fa-bars"></i></div>
                  </div>
               </div>
               <form id="finegrainedSearch" method="get" onsubmit="return searchFormSubmit(this);" action="/search/doc-search.html">
                  <div id="search-form"><select id="search-select" name="searchPath">
                        <option value="all">Entire Site</option>
                        <option value="AWSMarketplace">AMIs from AWS Marketplace</option>
                        <option value="amis">AMIs from All Sources</option>
                        <option value="articles">Articles &amp; Tutorials</option>
                        <option value="products_and_info">AWS Product Information</option>
                        <option value="case_studies">Case Studies</option>
                        <option value="customerapps">Customer Apps</option>
                        <option value="documentation">Documentation</option>
                        <option value="documentation-product">Documentation - This Product</option>
                        <option value="documentation-guide" selected="selected">Documentation - This Guide</option>
                        <option value="datasets">Public Data Sets</option>
                        <option value="releasenotes">Release Notes</option>
                        <option value="solution_providers">Partners</option>
                        <option value="code">Sample Code &amp; Libraries</option></select><br /><input id="search-query" name="searchQuery" type="text" placeholder="Search" /><input id="search-button" src="images/search-button.png" alt="Go" type="image" /></div><input type="hidden" name="this_doc_product" id="this_doc_product" value="Amazon Pinpoint" /><input type="hidden" name="this_doc_guide" id="this_doc_guide" value="Developer Guide" /><input type="hidden" name="doc_locale" value="en_us" /></form>
            </div>
            <div id="toc"></div>
         </div>
         <div id="main-column">
            <div id="main">
               <div id="main-content">
                  <div id="main-col-body">
                     <table summary="Breadcrumbs">
                        <tr>
                           <td>
                              <div class="breadcrumb"><a href="/index.html">AWS Documentation</a> » <a href="/pinpoint/index.html">Amazon Pinpoint</a> » <a href="index.html">Developer Guide</a> » <a href="tutorials.html">Tutorials</a> » <a href="tutorials-two-way-sms.html">Tutorial: Setting Up an SMS Registration
                                    System</a> » <span class="breadcrumb">Step 3: Create Lambda Functions</span></div>
                           </td>
                        </tr>
                     </table>
                     <div id="language-notice">
                        <div class="language-notice-text"></div>
                     </div>
                     <div></div>
                     <h1 class="topictitle" id="tutorials-two-way-sms-part-3">Step 3: Create Lambda Functions</h1>
                     <p>This solution uses two Lambda functions. This section shows you how to create and
                        configure
                        these functions. Later, you set up API Gateway and Amazon Pinpoint to execute these
                        functions when certain
                        events occur. Both of these functions create and update endpoints in the Amazon Pinpoint
                        project that
                        you specify. The first function also uses the phone number validation feature.
                     </p>
                     
                     <h2 id="tutorials-two-way-sms-part-3-create-register-function">Step 3.1: Create
                        the Function That Validates Customer Information and Creates Endpoints
                     </h2>
                     
                     <p>The first function takes input from your registration form, which it receives from
                        Amazon API Gateway.
                        It uses this information to obtain information about the customer's phone number by
                        using the <a href="https://docs.aws.amazon.com/pinpoint/latest/userguide/channels-sms-verify.html">phone number
                           validation</a> feature of Amazon Pinpoint. The function then uses the validated data to
                        create a new endpoint in the Amazon Pinpoint project that you specify. By default,
                        the endpoint
                        that the function creates is opted out of future communications from you, but this
                        status can be changed by the second function. Finally, this function sends the customer
                        a message asking them to verify that they want to receive SMS communications from
                        you.
                     </p>
                     
                     <p class="title"><b>To create the Lambda function</b></p>
                     <ol>
                        <li>
                           <p>Open the AWS Lambda console at
                              <a href="https://console.aws.amazon.com/lambda/" target="_blank">https://console.aws.amazon.com/lambda/</a>.
                           </p>
                        </li>
                        <li>
                           
                           <p>Choose <b>Create function</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Create a function</b>, choose
                              <b>Blueprints</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>In the search field, enter <strong class="userinput"><code>hello</code></strong>, and then press Enter.
                              In the list of results, choose the <code class="code">hello-world</code> Node.js function, as
                              shown in the following image. Choose <b>Configure</b>.
                           </p>
                           
                           <div class="mediaobject">
                              
                              <img src="images/SMS_Reg_Tutorial_LAM_Step1.4.png" />
                              
                              
                           </div>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Basic information</b>, do the following:
                           </p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p>For <b>Name</b>, enter a name for the function, such as
                                       <strong class="userinput"><code>RegistrationForm</code></strong>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>For <b>Role</b>, select <b>Choose an existing
                                          role</b>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>For <b>Existing role</b>, choose the
                                       <b>SMSRegistrationForm</b> role that you created in
                                       <a href="tutorials-two-way-sms-part-2.html#tutorials-two-way-sms-part-2-create-role">Step
                                          2.2</a>.
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                           <p>When you finish, choose <b>Create function</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Delete the sample function in the code editor, and then paste the following
                              code:
                           </p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="js ">var AWS = require('aws-sdk');
var pinpoint = new AWS.Pinpoint({region: process.env.region}); 

// Make sure the SMS channel is enabled for the projectId that you specify.
// See: https://docs.aws.amazon.com/pinpoint/latest/userguide/channels-sms-setup.html
var projectId = process.env.projectId;

// You need a dedicated long code in order to use two-way SMS. 
// See: https://docs.aws.amazon.com/pinpoint/latest/userguide/channels-voice-manage.html#channels-voice-manage-request-phone-numbers
var originationNumber = process.env.originationNumber;

// This message is spread across multiple lines for improved readability.
var message = "ExampleCorp: Reply YES to confirm your subscription. 2 msgs per "
            + "month. No purchase req'd. Msg&amp;data rates may apply. Terms: "
            + "example.com/terms-sms";
            
var messageType = "TRANSACTIONAL";

exports.handler = (event, context, callback) =&gt; {
  console.log('Received event:', event);
  validateNumber(event);
};

function validateNumber (event) {
  var destinationNumber = event.destinationNumber;
  if (destinationNumber.length == 10) {
    destinationNumber = "+1" + destinationNumber;
  }
  var params = {
    NumberValidateRequest: {
      IsoCountryCode: 'US',
      PhoneNumber: destinationNumber
    }
  };
  pinpoint.phoneNumberValidate(params, function(err, data) {
    if (err) {
      console.log(err, err.stack);
    }
    else {
      console.log(data);
      //return data;
      if (data['NumberValidateResponse']['PhoneTypeCode'] == 0) {
        createEndpoint(data, event.firstName, event.lastName, event.source);
      } else {
        console.log("Received a phone number that isn't capable of receiving "
                   +"SMS messages. No endpoint created.");
      }
    }
  });
}

function createEndpoint(data, firstName, lastName, source) {
  var destinationNumber = data['NumberValidateResponse']['CleansedPhoneNumberE164'];
  var endpointId = data['NumberValidateResponse']['CleansedPhoneNumberE164'].substring(1);
  
  var params = {
    ApplicationId: projectId,
    // The Endpoint ID is equal to the cleansed phone number minus the leading
    // plus sign. This makes it easier to easily update the endpoint later.
    EndpointId: endpointId,
    EndpointRequest: {
      ChannelType: 'SMS',
      Address: destinationNumber,
      // OptOut is set to ALL (that is, endpoint is opted out of all messages)
      // because the recipient hasn't confirmed their subscription at this
      // point. When they confirm, a different Lambda function changes this 
      // value to NONE (not opted out).
      OptOut: 'ALL',
      Location: {
        PostalCode:data['NumberValidateResponse']['ZipCode'],
        City:data['NumberValidateResponse']['City'],
        Country:data['NumberValidateResponse']['CountryCodeIso2'],
      },
      Demographic: {
        Timezone:data['NumberValidateResponse']['Timezone']
      },
      Attributes: {
        Source: [
          source
        ]
      },
      User: {
        UserAttributes: {
          FirstName: [
            firstName
          ],
          LastName: [
            lastName
          ]
        }
      }
    }
  };
  pinpoint.updateEndpoint(params, function(err,data) {
    if (err) {
      console.log(err, err.stack);
    }
    else {
      console.log(data);
      //return data;
      sendConfirmation(destinationNumber);
    }
  });
}

function sendConfirmation(destinationNumber) {
  var params = {
    ApplicationId: projectId,
    MessageRequest: {
      Addresses: {
        [destinationNumber]: {
          ChannelType: 'SMS'
        }
      },
      MessageConfiguration: {
        SMSMessage: {
          Body: message,
          MessageType: messageType,
          OriginationNumber: originationNumber
        }
      }
    }
  };

  pinpoint.sendMessages(params, function(err, data) {
    // If something goes wrong, print an error message.
    if(err) {
      console.log(err.message);
    // Otherwise, show the unique ID for the message.
    } else {
      console.log("Message sent! " 
          + data['MessageResponse']['Result'][destinationNumber]['StatusMessage']);
    }
  });
}</code></pre>
                           </li>
                        <li>
                           
                           <p>Under <b>Environment variables</b>, do the following:
                           </p>
                           
                           <div class="itemizedlist">                    
                              
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p>In the first row, create a variable with a key of
                                       <strong class="userinput"><code>originationNumber</code></strong>. Next, set the value to the
                                       phone number of the dedicated long code that you received in <a href="tutorials-two-way-sms-part-1.html#tutorials-two-way-sms-part-1-set-up-channel">Step
                                          1.2</a>.
                                    </p>
                                    
                                    <div class="aws-note">
                                       <p class="aws-note">Note</p>
                                       <p>Be sure to include the plus sign (+) and the country code for the
                                          phone number. Don't include any other special characters, such as
                                          dashes (-), periods (.), or parentheses.
                                       </p>
                                    </div>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>In the second row, create a variable with a key of
                                       <strong class="userinput"><code>projectId</code></strong>. Next, set the value to the unique
                                       ID of the project that you created in <a href="tutorials-two-way-sms-part-1.html#tutorials-two-way-sms-part-1-create-project">Step
                                          1.1</a>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>In the third row, create a variable with a key of
                                       <strong class="userinput"><code>region</code></strong>. Next, set the value to the Region
                                       that you use Amazon Pinpoint in, such as <strong class="userinput"><code>us-east-1</code></strong> or
                                       <strong class="userinput"><code>us-west-2</code></strong>.
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                           <p>When you finish, the <b>Environment Variables</b> section should
                              resemble the example shown in the following image.
                           </p>
                           
                           <div class="mediaobject">
                              
                              <img src="images/SMS_Reg_Tutorial_LAM_Step1.7.png" />
                              
                              
                           </div>
                           
                        </li>
                        <li>
                           
                           <p>At the top of the page, choose <b>Save</b>.
                           </p>
                           
                        </li>
                     </ol>
                     
                     
                     <h3 id="tutorials-two-way-sms-part-3-create-register-function-test">Step
                        3.1.1: Test the Function
                     </h3>
                     
                     <p>After you create the function, you should test it to make sure that it's
                        configured properly. Also, make sure that the IAM role you created has the
                        appropriate permissions.
                     </p>
                     
                     <p class="title"><b>To test the function</b></p>
                     <ol>
                        <li>
                           
                           <p>Choose <b>Test</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>On the <b>Configure test event</b> window, do the
                              following:
                           </p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p>Choose <b>Create new test event</b>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>For <b>Event name</b>, enter a name for the test
                                       event, such as <strong class="userinput"><code>MyPhoneNumber</code></strong>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>Erase the example code in the code editor. Paste the following
                                       code:
                                    </p>
                                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="json ">{
  "destinationNumber": "<em class="replaceable"><code>2065550142</code></em>",
  "firstName": "<em class="replaceable"><code>Carlos</code></em>",
  "lastName": "<em class="replaceable"><code>Salazar</code></em>",
  "source": "Registration form test"
}</code></pre>
                                    </li>
                                 <li class="listitem">
                                    
                                    <p>In the preceding code example, replace the values of the
                                       <code class="code">destinationNumber</code>, <code class="code">firstName</code>, and
                                       <code class="code">lastName</code> attributes with the values that you want
                                       to use for testing, such as your personal contact details. When you
                                       test this function, it sends an SMS message to the phone number that
                                       you specify in the <code class="code">destinationNumber</code> attribute. Make
                                       sure that the phone number that you specify is able to receive SMS
                                       messages.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>Choose <b>Create</b>.
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                        </li>
                        <li>
                           
                           <p>Choose <b>Test</b> again.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Execution result: succeeded</b>, choose
                              <b>Details</b>. In the <b>Log output</b>
                              section, review the output of the function. Make sure that the function ran
                              without errors.
                           </p>
                           
                           <p>Check the device that's associated with the <code class="code">destinationNumber</code>
                              that you specified to make sure that it received the test message.
                           </p>
                           
                        </li>
                        <li>
                           <p>Open the Amazon Pinpoint console at
                              <a href="https://console.aws.amazon.com/pinpoint/" target="_blank">https://console.aws.amazon.com/pinpoint/</a>.
                           </p>
                        </li>
                        <li>
                           
                           <p>On the <b>All projects</b> page, choose the project that you
                              created in <a href="tutorials-two-way-sms-part-1.html#tutorials-two-way-sms-part-1-create-project">Step
                                 1.1</a>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>In the navigation pane, choose <b>Segments</b>. On the
                              <b>Segments page</b>, choose <b>Create a
                                 segment</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>In <b>Segment group 1</b>, under <b>Add filters to
                                 refine your segment</b>, choose <b>Filter by
                                 user</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>For <b>Choose a user attribute</b>, choose
                              <b>FirstName</b>. Then, for <b>Choose
                                 values</b>, choose the first name that you specified in the test
                              event.
                           </p>
                           
                           <p>The <b>Segment estimate</b> section should show that there
                              are zero eligible endpoints, and one total endpoint, as shown in the
                              following image. This result is expected. When the function creates a new
                              endpoint, the endpoint is opted out. Segments in Amazon Pinpoint automatically exclude
                              opted-out endpoints.
                           </p>
                           
                           <div class="mediaobject">
                              
                              <img src="images/SMS_Reg_Tutorial_LAM_Step8.9.png" />
                              
                              
                           </div>
                           
                        </li>
                     </ol>
                     
                     
                     
                     <h2 id="tutorials-two-way-sms-part-3-create-optin-function">Step 3.2: Create
                        the Function That Opts in Customers to Your Communications
                     </h2>
                     
                     <p>The second function is only executed when a customer replies to the message that's
                        sent by the first function. If the customer's reply includes the keyword that you
                        specified in <a href="tutorials-two-way-sms-part-1.html#tutorials-two-way-sms-part-1-set-up-channel">Step
                           1.3</a>, the function updates their endpoint record to opt them in to future
                        communications. Amazon Pinpoint also automatically responds with the message that
                        you specified in
                        Step 1.3.
                     </p>
                     
                     <p>If the customer doesn't respond, or responds with anything other than the designated
                        keyword, then nothing happens. The customer's endpoint remains in Amazon Pinpoint,
                        but it can't be
                        targeted by segments.
                     </p>
                     
                     <p class="title"><b>To create the Lambda function</b></p>
                     <ol>
                        <li>
                           <p>Open the AWS Lambda console at
                              <a href="https://console.aws.amazon.com/lambda/" target="_blank">https://console.aws.amazon.com/lambda/</a>.
                           </p>
                        </li>
                        <li>
                           
                           <p>Choose <b>Create function</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Create function</b>, choose
                              <b>Blueprints</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>In the search field, enter <strong class="userinput"><code>hello</code></strong>, and then press Enter.
                              In the list of results, choose the <code class="code">hello-world</code> Node.js function, as
                              shown in the following image. Choose <b>Configure</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Basic information</b>, do the following:
                           </p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p>For <b>Name</b>, enter a name for the function, such as
                                       <strong class="userinput"><code>RegistrationForm_OptIn</code></strong>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>For <b>Role</b>, select <b>Choose an existing
                                          role</b>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>For <b>Existing role</b>, choose the SMSRegistrationForm
                                       role that you created in <a href="tutorials-two-way-sms-part-2.html#tutorials-two-way-sms-part-2-create-role">Step
                                          2.2</a>.
                                    </p>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                           <p>When you finish, choose <b>Create function</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Delete the sample function in the code editor, and then paste the following
                              code:
                           </p>
                           <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="js ">var AWS = require('aws-sdk');
var projectId = process.env.projectId;
var confirmKeyword = process.env.confirmKeyword.toLowerCase();
var pinpoint = new AWS.Pinpoint({region: process.env.region});

exports.handler = (event, context) =&gt; {
  console.log('Received event:', event);
  var timestamp = event.Records[0].Sns.Timestamp;
  var message = JSON.parse(event.Records[0].Sns.Message);
  var originationNumber = message.originationNumber;
  var response = message.messageBody.toLowerCase();
  
  if (response.includes(confirmKeyword)) {
    updateEndpointOptIn(originationNumber, timestamp);  
  }
};

function updateEndpointOptIn (originationNumber, timestamp) {
  var endpointId = originationNumber.substring(1);
  
  var params = {
    ApplicationId: projectId,
    EndpointId: endpointId,
    EndpointRequest: { 
      Address: originationNumber,
      ChannelType: 'SMS',
      OptOut: 'NONE',
      Attributes: {
        OptInTimestamp: [
          timestamp
        ]
      },
    }
  };
  pinpoint.updateEndpoint(params, function(err, data) {
    if (err) {
      console.log("An error occurred.\n");
      console.log(err, err.stack);
    }
    else {
      console.log("Successfully changed the opt status of endpoint ID " + endpointId);
    }
  });
} </code></pre>
                           </li>
                        <li>
                           
                           <p>Under <b>Environment variables</b>, do the following:
                           </p>
                           
                           <div class="itemizedlist">
                              
                              
                              
                              
                              <ul class="itemizedlist" type="disc">
                                 <li class="listitem">
                                    
                                    <p>In the first row, create a variable with a key of
                                       <strong class="userinput"><code>appId</code></strong>. Next, set the value to the unique ID
                                       of the project that you created in <a href="tutorials-two-way-sms-part-1.html#tutorials-two-way-sms-part-1-create-project">Step
                                          1.1</a>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>In the second row, create a variable with a key of
                                       <strong class="userinput"><code>region</code></strong>. Next, set the value to the Region
                                       that you use Amazon Pinpoint in, such as <strong class="userinput"><code>us-east-1</code></strong> or
                                       <strong class="userinput"><code>us-west-2</code></strong>.
                                    </p>
                                    
                                 </li>
                                 <li class="listitem">
                                    
                                    <p>In the third row, create a variable with a key of
                                       <strong class="userinput"><code>confirmKeyword</code></strong>. Next, set the value to the
                                       confirmation keyword that you created in <a href="tutorials-two-way-sms-part-1.html#tutorials-two-way-sms-part-1-set-up-channel">Step
                                          1.3</a>.
                                    </p>
                                    
                                    <div class="aws-note">
                                       <p class="aws-note">Note</p>
                                       <p>The keyword isn't case sensitive. This function converts the
                                          incoming message to lowercase letters.
                                       </p>
                                    </div>
                                    
                                 </li>
                              </ul>
                           </div>
                           
                           <p>When you finish, the <b>Environment Variables</b> section should
                              resemble the example shown in the following image.
                           </p>
                           
                           <div class="mediaobject">
                              
                              <img src="images/SMS_Reg_Tutorial_LAM_Step2.7.png" />
                              
                              
                           </div>
                           
                        </li>
                        <li>
                           
                           <p>At the top of the page, choose <b>Save</b>.
                           </p>
                           
                        </li>
                     </ol>
                     
                     
                     <h3 id="tutorials-two-way-sms-part-3-create-optin-function-test">Step
                        3.2.1: Test the Function
                     </h3>
                     
                     <p>After you create the function, you should test it to make sure that it's
                        configured properly. Also, make sure that the IAM role you created has the
                        appropriate permissions.
                     </p>
                     
                     <p class="title"><b>To test the function</b></p>
                     <ol>
                        <li>
                           
                           <p>Choose <b>Test</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>On the <b>Configure test event</b> window, do the
                              following:
                           </p>
                           
                           <ol>
                              <li>
                                 
                                 <p>Choose <b>Create new test event</b>.
                                 </p>
                                 
                              </li>
                              <li>
                                 
                                 <p>For <b>Event name</b>, enter a name for the test
                                    event, such as <strong class="userinput"><code>MyResponse</code></strong>.
                                 </p>
                                 
                              </li>
                              <li>
                                 
                                 <p>Erase the example code in the code editor. Paste the following
                                    code:
                                 </p>
                                 <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"></div><div class="btn-dark-theme" title="Dark theme" title-dark="Dark theme" title-light="Light theme"></div></div><code class="json ">{
  "Records":[
    {
      "Sns":{
        "Message":"{\"originationNumber\":\"<em class="replaceable"><code>+12065550142</code></em>\",\"messageBody\":\"<em class="replaceable"><code>Yes</code></em>\"}",
        "Timestamp":"2019-02-20T17:47:44.147Z"
      }
    }
  ]
}
</code></pre>
                                 <p>In the preceding code example, replace the values of the
                                    <code class="code">originationNumber</code> attribute with the phone number
                                    that you used when you tested the previous Lambda function. Replace
                                    the value of <code class="code">messageBody</code> with the two-way SMS keyword
                                    that you specified in <a href="tutorials-two-way-sms-part-1.html#tutorials-two-way-sms-part-1-enable-two-way">Step
                                       1.3</a>. Optionally, you can replace the value of
                                    <code class="code">Timestamp</code> with the current date and time.
                                 </p>
                                 
                              </li>
                              <li>
                                 
                                 <p>Choose <b>Create</b>.
                                 </p>
                                 
                              </li>
                           </ol>
                           
                        </li>
                        <li>
                           
                           <p>Choose <b>Test</b> again.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>Under <b>Execution result: succeeded</b>, choose
                              <b>Details</b>. In the <b>Log output</b>
                              section, review the output of the function. Make sure that the function ran
                              without errors.
                           </p>
                           
                        </li>
                        <li>
                           <p>Open the Amazon Pinpoint console at
                              <a href="https://console.aws.amazon.com/pinpoint/" target="_blank">https://console.aws.amazon.com/pinpoint/</a>.
                           </p>
                        </li>
                        <li>
                           
                           <p>On the <b>All projects</b> page, choose the project that you
                              created in <a href="tutorials-two-way-sms-part-1.html#tutorials-two-way-sms-part-1-create-project">Step
                                 1.1</a>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>In the navigation pane, choose <b>Segments</b>. On the
                              <b>Segments page</b>, choose <b>Create a
                                 segment</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>In <b>Segment group 1</b>, under <b>Add filters to
                                 refine your segment</b>, choose <b>Filter by
                                 user</b>.
                           </p>
                           
                        </li>
                        <li>
                           
                           <p>For <b>Choose a user attribute</b>, choose
                              <b>FirstName</b>. Then, for <b>Choose
                                 values</b>, choose the first name that you specified in the test
                              event.
                           </p>
                           
                           <p>The <b>Segment estimate</b> section should show that there
                              is one eligible endpoint, and one total endpoint.
                           </p>
                           
                        </li>
                     </ol>
                     
                     
                     <p><b>Next</b>: <a href="tutorials-two-way-sms-part-4.html">Set up
                           Amazon API Gateway</a></p>
                  </div>
                  <noscript>
                     <div>
                        <div>
                           <div>
                              <div id="js_error_message">
                                 <p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p>
                                 <p>To use the AWS Documentation, Javascript must be enabled. Please refer to your browser's
                                    Help pages for instructions.
                                 </p>
                              </div>
                           </div>
                        </div>
                     </div>
                  </noscript>
                  <div id="main-col-footer">
                     <div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div>
                     <div id="next"><a class="awstoc" accesskey="p" href="tutorials-two-way-sms-part-2.html">« Previous </a><a class="awstoc" accesskey="n" href="tutorials-two-way-sms-part-4.html">Next »</a></div>
                     <div id="copyright-main-footer">© 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.</div>
                  </div>
               </div>
            </div>
            <div id="right-expanded">
               <div id="right-content-wrapper">
                  <div id="pagetoc">
                     <p>On this page:</p>
                     <ul class="pagetoc">
                        <li class="pagetoc" name="Step 3.1: Create&#xA;                the Function That Validates Customer Information and Creates Endpoints"><a class="pagetoc" href="#tutorials-two-way-sms-part-3-create-register-function">Create the Function That Validates Customer Information and Creates
                              Endpoints</a></li>
                        <li class="pagetoc" name="Step 3.2: Create&#xA;                the Function That Opts in Customers to Your Communications"><a class="pagetoc" href="#tutorials-two-way-sms-part-3-create-optin-function">Create
                              the Function That Opts in Customers to Your Communications</a></li>
                     </ul>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div id="cookie-notice">
         <div class="cookie-notice-text">We use cookies to provide and improve our services. By using our site, you consent
            to cookies. <a href="http://aws.amazon.com/legal/cookies">Learn more</a></div>
      </div>
      <div id="footer">
         <div id="footer_short_fb" class="hide" title="Feedback"><a target="_blank" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Pinpoint&amp;topic_url=http://docs.aws.amazon.com/en_us/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html&amp;hidden_guide_name=Developer Guide&amp;hidden_api_version=&amp;hidden_file_name=tutorials-two-way-sms-part-3"><i class="awsdocs-footer-text fa fa-envelope-o"></i></a></div>
         <div id="footer_toggle" class="mediaobject">
            <div id="footer_toggle_img" class="awsdocs-footer-text fa fa-caret-down"></div>
            <div id="footer_toggle_img_collapse" class="hide awsdocs-footer-text fa fa-caret-right"></div>
         </div>
         <div id="footer-left"><a class="awsdocs-footer-text" target="_top" href="http://aws.amazon.com/terms">Terms of Use</a><span class="awsdocs-footer-text"> | </span><a class="awsdocs-footer-text" target="_top" href="http://aws.amazon.com/privacy">Privacy</a><span class="awsdocs-footer-text"> | </span><span class="awsdocs-footer-text">© 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.</span></div>
         <div id="footer-right">
            <div id="feedback">
               <div id="forums"><a id="forum_link" target="_blank" href="http://forums.aws.amazon.com/forum.jspa?forumID=225" class="awsdocs-footer-text">Have a question? Try the Forums.</a></div>
               <div id="feedback-message" class="awsdocs-footer-text">Did this page help you?</div>
               <div id="feedback-yesno-buttons"><a class="awstoc btn btn-default" target="_blank" href="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">Yes</a><a class="awstoc btn btn-default" target="_blank" href="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html">No</a></div>
               <div id="feedback-feedback-button"><a class="awstoc btn btn-default" target="_blank" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Pinpoint&amp;topic_url=http://docs.aws.amazon.com/en_us/pinpoint/latest/developerguide/tutorials-two-way-sms-part-3.html&amp;hidden_guide_name=Developer Guide&amp;hidden_api_version=&amp;hidden_file_name=tutorials-two-way-sms-part-3">Feedback</a></div>
            </div>
         </div>
      </div>
      <!-- SiteCatalyst code version: H.25.2.
            Copyright 1996-2012 Adobe, Inc. All Rights Reserved
            More info available at http://www.omniture.com --><script language="JavaScript" type="text/javascript" src="https://a0.awsstatic.com/s_code/js/1.0/awshome_s_code.js"></script><script language="JavaScript" type="text/javascript">
         <!--

            // Documentation Service Name
            s.prop66='Amazon Pinpoint';
            s.eVar66='D=c66';
  
            // Documentation Guide Name                                                                 
            s.prop65='Developer Guide';
            s.eVar65='D=c65';

            var s_code=s.t();if(s_code)document.write(s_code)//--></script><script language="JavaScript" type="text/javascript">
         <!--
                if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
                //--></script><noscript><img src="https://amazonwebservices.d2.sc.omtrdc.net/b/ss/awsamazondev/1/H.25.2--NS/0" height="1" width="1" border="0" alt="" /></noscript>
      <!--/DO NOT REMOVE/-->
      <!-- End SiteCatalyst code version: H.25.2. -->
   </body>
</html>